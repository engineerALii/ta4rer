<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Report Builder iOS</title>
    
    <!-- Site Icons -->
    <link rel="icon" href="https://logo-icons.com/cdn/shop/files/201-logo-1712247205.834color-A52A2A.svg?v=1712759420&width=416" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://logo-icons.com/cdn/shop/files/201-logo-1712247205.834color-A52A2A.svg?v=1712759420&width=416">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700&family=Poppins:wght@400;600&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. iOS THEME VARIABLES
           ========================================= */
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-card-border: rgba(255, 255, 255, 0.12);
            --ios-primary: #0A84FF;
            --ios-text: #FFFFFF;
            --ios-text-secondary: #8E8E93;
            --ios-separator: #38383a;
            --ios-danger: #FF453A;
            --ios-success: #30D158;
            
            --radius-l: 20px;
            --radius-m: 12px;
            
            /* Fonts */
            --font-main: -apple-system, BlinkMacSystemFont, 'Tajawal', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--ios-bg);
            color: var(--ios-text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden; /* App-like feel */
        }

        /* App Container (Mobile Simulator on Desktop) */
        .ios-app {
            width: 100%;
            max-width: 600px; /* Tablet/Desktop limit */
            height: 100vh;
            background: var(--ios-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* =========================================
           2. HEADER & NAVIGATION
           ========================================= */
        .ios-header {
            padding: 50px 20px 10px; /* Top padding for notch area */
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--ios-separator);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ios-title { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; }
        .ios-subtitle { font-size: 13px; color: var(--ios-text-secondary); font-weight: 600; text-transform: uppercase; }

        /* Content Scroll Area */
        .ios-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 100px; /* Space for tab bar */
            scroll-behavior: smooth;
        }

        /* Tab Bar */
        .ios-tab-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 85px;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--ios-separator);
            display: flex;
            justify-content: space-around;
            padding-bottom: 20px; /* Safe area */
            z-index: 200;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--ios-text-secondary);
            font-size: 10px;
            gap: 5px;
            width: 100%;
            cursor: pointer;
            transition: 0.2s;
        }

        .tab-item.active { color: var(--ios-primary); }
        .tab-icon { font-size: 24px; }

        /* =========================================
           3. UI COMPONENTS (iOS Style)
           ========================================= */
        /* Grouped List Style */
        .ios-list-group {
            background: var(--ios-card);
            border-radius: var(--radius-m);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .ios-list-header {
            padding: 0 15px 8px;
            font-size: 13px;
            color: var(--ios-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .ios-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--ios-card);
            border-bottom: 0.5px solid var(--ios-separator);
            min-height: 44px;
        }
        .ios-list-item:last-child { border-bottom: none; }

        .item-label { width: 100px; font-size: 16px; font-weight: 500; }
        
        .item-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--ios-primary);
            font-size: 16px;
            text-align: left; /* RTL support handled by dir="rtl" */
            font-family: inherit;
        }
        .item-input::placeholder { color: var(--ios-text-secondary); opacity: 0.5; }
        
        .item-select {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--ios-primary);
            font-size: 16px;
            direction: ltr; /* Align select arrows nicely */
            appearance: none;
            text-align: right;
        }

        /* Buttons */
        .ios-btn {
            background: var(--ios-card);
            color: var(--ios-primary);
            border: none;
            border-radius: var(--radius-m);
            padding: 14px;
            font-size: 17px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .ios-btn:active { background: rgba(255,255,255,0.1); }
        
        .btn-primary { background: var(--ios-primary); color: white; }
        .btn-danger { color: var(--ios-danger); }

        /* File Upload */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-upload-wrapper input[type=file] {
            position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;
        }

        /* Views Logic */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           4. PREVIEW & EDITOR (Refined)
           ========================================= */
        .preview-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: hidden;
            margin-top: 10px;
        }

        /* Scalable A4 Wrapper */
        .a4-wrapper {
            width: 210mm;
            height: 297mm;
            background: white;
            color: black;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            /* Scale logic handled in JS for responsiveness */
            transform-origin: top center;
            padding: 20mm;
            overflow: hidden; 
            z-index: 1;
            /* Default background settings */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* --- SIMPLE IMAGE LOGIC (FIXED) --- */
        
        /* When image is uploaded: Just show the image on the wrapper */
        .a4-wrapper.has-image {
            /* Important: We rely on JS to set background-image directly now to avoid variable issues */
            background-size: 100% 100% !important; /* Force fit to A4 dimensions */
            padding: 0 !important; /* Remove padding so image touches edges */
        }

        /* Hide text content when image is active */
        .a4-wrapper.has-image .report-content-wrapper { 
            display: none !important; 
        }

        /* Editor Paper */
        .editor-paper {
            background: white; 
            width: 100%; 
            min-height: 297mm;
            padding: 25.4mm;
            color: black;
            font-size: 14pt;
            line-height: 1.6;
            outline: none;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow-wrap: break-word;
        }
        
        .editor-paper:focus { box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.5); }

        /* Toolbar */
        .editor-toolbar {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .editor-toolbar::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome/Safari */

        .toolbar-btn {
            background: var(--ios-card);
            border: 1px solid var(--ios-card-border);
            color: var(--ios-text);
            min-width: 44px; height: 44px;
            border-radius: 10px;
            font-size: 18px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.1s;
        }
        .toolbar-btn:active { background: var(--ios-primary); color: white; }
        .toolbar-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* Credits */
        .ios-credits {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--ios-text-secondary);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }
        .credits-icon svg { width: 20px; fill: #E1306C; }

        /* =========================================
           5. THEMES & CONTENT
           ========================================= */
        [data-theme="formal"] { border: 1px solid #ddd; }
        [data-theme="formal"] .report-header { text-align: center; border-bottom: 3px double #000; padding-bottom: 20px; margin-bottom: 40px; }
        [data-theme="modern"]::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 15mm; background: linear-gradient(90deg, #0A84FF, #5E5CE6); }
        
        .report-header { text-align: center; margin-bottom: 40px; }
        .uni-logo-placeholder { width: 80px; height: 80px; background: #f2f2f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }
        .report-title { font-size: 2.2rem; font-weight: 800; text-align: center; margin: 30px 0; }
        .report-meta { text-align: right; border: 1px solid #ccc; padding: 20px; width: 80%; margin: 0 auto; }
        .meta-row { display: flex; margin-bottom: 10px; font-size: 1.1rem; }
        .meta-label { font-weight: bold; width: 120px; }

        /* Fonts */
        .font-tajawal { font-family: 'Tajawal', sans-serif !important; }
        .font-cairo { font-family: 'Cairo', sans-serif !important; }
        .font-amiri { font-family: 'Amiri', serif !important; }
        .font-poppins { font-family: 'Poppins', sans-serif !important; }

        /* PRINT */
        @media print {
            body, .ios-app { background: white; height: auto; display: block; overflow: visible; }
            .ios-header, .ios-tab-bar, .ios-content, .editor-toolbar, .ios-credits { display: none !important; }
            .view-section { display: block !important; }
            .a4-wrapper, .editor-paper { box-shadow: none; margin: 0; transform: none !important; width: 210mm; page-break-after: always; }
            /* Reset colors for print */
            * { color: black !important; }
            
            /* Ensure background prints */
            .a4-wrapper.has-image {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div class="ios-app">
        <!-- Header -->
        <header class="ios-header">
            <div>
                <div class="ios-subtitle">2026 Edition</div>
                <div class="ios-title">Report Pro</div>
            </div>
            <div style="width: 40px; height: 40px; background: var(--ios-card); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                üìÑ
            </div>
        </header>

        <!-- Main Content -->
        <main class="ios-content">
            
            <!-- VIEW 1: SETTINGS (Edit) -->
            <div id="view-settings" class="view-section active">
                
                <div class="ios-list-header">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∫ŸÑÿßŸÅ</div>
                <div class="ios-list-group">
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑÿ¨ÿßŸÖÿπÿ©</label>
                        <input type="text" class="item-input" id="uniName" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿßÿ≥ŸÖ..." oninput="updatePreview()">
                    </div>
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                        <input type="text" class="item-input" id="reportTitle" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ®ÿ≠ÿ´..." oninput="updatePreview()">
                    </div>
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑŸÖÿ¥ÿ±ŸÅ</label>
                        <input type="text" class="item-input" id="supervisorName" placeholder="ÿØ. ÿßŸÑÿßÿ≥ŸÖ..." oninput="updatePreview()">
                    </div>
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑÿ≥ŸÜÿ©</label>
                        <input type="text" class="item-input" id="yearText" placeholder="2025-2026" oninput="updatePreview()">
                    </div>
                </div>

                <div class="ios-list-header">ÿßŸÑÿ∑ŸÑÿßÿ®</div>
                <div class="ios-list-group" id="studentsList">
                    <div class="ios-list-item">
                        <input type="text" class="item-input student-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ® 1" oninput="updatePreview()" value="ÿ∑ÿßŸÑÿ® 1">
                    </div>
                </div>
                <button class="ios-btn" onclick="addStudent()">
                    <span style="font-size:20px">+</span> ÿ•ÿ∂ÿßŸÅÿ© ÿ∑ÿßŸÑÿ®
                </button>

                <div class="ios-list-header">ÿßŸÑÿ™ÿÆÿµŸäÿµ</div>
                <div class="ios-list-group">
                    <div class="ios-list-item">
                        <label class="item-label">ÿµŸàÿ±ÿ© ÿ∫ŸÑÿßŸÅ</label>
                        <div class="file-upload-wrapper item-input">
                            <span style="color:var(--ios-primary)">ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©...</span>
                            <input type="file" id="coverImageInput" accept="image/*" onchange="handleCoverImage(this)">
                        </div>
                        <button onclick="removeCoverImage()" style="background:none; border:none; color:var(--ios-danger); display:none;" id="removeImgBtn">‚úï</button>
                    </div>
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑÿÆÿ∑</label>
                        <select id="fontSelect" class="item-select" onchange="updateFont()">
                            <option value="font-tajawal">Tajawal</option>
                            <option value="font-cairo">Cairo</option>
                            <option value="font-amiri">Amiri</option>
                            <option value="font-poppins">Poppins</option>
                        </select>
                    </div>
                    <div class="ios-list-item">
                        <label class="item-label">ÿßŸÑÿ™ÿµŸÖŸäŸÖ</label>
                        <select id="themeSelect" class="item-select" onchange="updateTheme()">
                            <option value="formal">ÿ±ÿ≥ŸÖŸä</option>
                            <option value="modern">ŸÖŸàÿØÿ±ŸÜ</option>
                            <option value="corporate">ÿ¥ÿ±ŸÉÿßÿ™</option>
                        </select>
                    </div>
                </div>

                <a href="https://instagram.com/c4man" target="_blank" class="ios-credits">
                    <div class="credits-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.5 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
                    </div>
                    <span>Design by Ali Abdulmuslim ¬© 2026</span>
                </a>
            </div>

            <!-- VIEW 2: COVER PREVIEW -->
            <div id="view-cover" class="view-section">
                <div class="ios-list-header" style="text-align:center; margin-bottom:10px;">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ∫ŸÑÿßŸÅ (A4)</div>
                <div class="preview-container" id="previewContainer">
                    <div id="a4Page" class="a4-wrapper font-tajawal" data-theme="formal">
                        <div class="report-content-wrapper">
                            <div class="report-header">
                                <div class="uni-logo-placeholder">üèõÔ∏è</div>
                                <h2 id="prevUni">ÿßŸÑÿ¨ÿßŸÖÿπÿ©</h2>
                            </div>
                            <div class="report-body">
                                <h1 class="report-title" id="prevTitle">ÿßŸÑÿπŸÜŸàÿßŸÜ</h1>
                                <div class="report-meta">
                                    <div class="meta-row"><span class="meta-label">ÿ•ÿ¥ÿ±ÿßŸÅ:</span><span id="prevSupervisor">...</span></div>
                                    <div class="meta-row"><span class="meta-label">ÿ•ÿπÿØÿßÿØ:</span><div id="prevStudents">...</div></div>
                                    <div class="meta-row"><span class="meta-label">ÿßŸÑÿπÿßŸÖ:</span><span id="prevYear">...</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="ios-btn btn-primary" style="margin-top:20px" onclick="window.print()">ÿ∑ÿ®ÿßÿπÿ© / ÿ≠ŸÅÿ∏ PDF üñ®Ô∏è</button>
            </div>

            <!-- VIEW 3: REPORT EDITOR -->
            <div id="view-editor" class="view-section">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" onclick="fmt('bold')" title="ÿπÿ±Ÿäÿ∂"><b>B</b></button>
                    <button class="toolbar-btn" onclick="fmt('italic')" title="ŸÖÿßÿ¶ŸÑ"><i>I</i></button>
                    <button class="toolbar-btn" onclick="fmt('underline')" title="ÿ™ÿ≥ÿ∑Ÿäÿ±"><u>U</u></button>
                    
                    <div style="width:1px; background:var(--ios-separator); margin:0 5px;"></div>
                    
                    <button class="toolbar-btn" onclick="fmt('justifyRight')" title="ŸäŸÖŸäŸÜ">
                        <svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="fmt('justifyCenter')" title="Ÿàÿ≥ÿ∑">
                        <svg viewBox="0 0 24 24"><path d="M7 21h10v-2H7v2zM3 17h18v-2H3v2zm4-4h10v-2H7v2zM3 9h18V7H3v2zm4-4h10V3H7v2z"/></svg>
                    </button>
                    <button class="toolbar-btn" onclick="fmt('justifyLeft')" title="Ÿäÿ≥ÿßÿ±">
                        <svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm0-4h12v-2H3v2zm0-4h18v-2H3v2zm0-4h12V7H3v2zm0-6v2h18V3H3z"/></svg>
                    </button>

                    <div style="width:1px; background:var(--ios-separator); margin:0 5px;"></div>

                    <button class="toolbar-btn" onclick="setDir('rtl')" title="ÿßÿ™ÿ¨ÿßŸá ÿπÿ±ÿ®Ÿä (RTL)">
                        <span style="font-size:12px">RTL</span>
                    </button>
                    <button class="toolbar-btn" onclick="setDir('ltr')" title="ÿßÿ™ÿ¨ÿßŸá ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä (LTR)">
                        <span style="font-size:12px">LTR</span>
                    </button>

                    <div style="width:1px; background:var(--ios-separator); margin:0 5px;"></div>

                    <button class="toolbar-btn" onclick="setSize(5)" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">A+</button>
                    <button class="toolbar-btn" onclick="setSize(3)" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">A-</button>
                    <button class="toolbar-btn" onclick="insertBreak()" title="ŸÅÿßÿµŸÑ ÿµŸÅÿ≠ÿßÿ™">üìÑ</button>
                </div>
                
                <div style="background:#f2f2f7; padding:10px; border-radius:10px; overflow:hidden;">
                    <div id="reportEditor" class="editor-paper font-tajawal" contenteditable="true" dir="auto" oninput="save()"></div>
                </div>
                <div class="ios-list-header" style="margin-top:5px;">ÿπÿØÿØ ÿßŸÑŸÉŸÑŸÖÿßÿ™: <span id="wordCount">0</span></div>
            </div>

        </main>

        <!-- Tab Bar Navigation -->
        <nav class="ios-tab-bar">
            <div class="tab-item active" onclick="switchView('settings', this)">
                <div class="tab-icon">‚öôÔ∏è</div>
                <span>ÿ•ÿπÿØÿßÿØÿßÿ™</span>
            </div>
            <div class="tab-item" onclick="switchView('cover', this)">
                <div class="tab-icon">üìÑ</div>
                <span>ÿßŸÑÿ∫ŸÑÿßŸÅ</span>
            </div>
            <div class="tab-item" onclick="switchView('editor', this)">
                <div class="tab-icon">üìù</div>
                <span>ŸÉÿ™ÿßÿ®ÿ©</span>
            </div>
        </nav>
    </div>

    <script>
        // --- Navigation Logic ---
        function switchView(viewId, el) {
            document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');

            if(viewId === 'cover') fitPreview();
        }

        // --- Fit A4 to Mobile Screen ---
        function fitPreview() {
            const wrapper = document.getElementById('a4Page');
            const container = document.getElementById('previewContainer');
            const width = container.offsetWidth;
            // A4 ratio 210/297 = ~0.707
            // We scale it based on width
            const a4PixelWidth = 794; 
            const scaleRatio = (width - 40) / a4PixelWidth; // 40px padding
            
            if(width < a4PixelWidth) {
                wrapper.style.transform = `scale(${scaleRatio})`;
                wrapper.style.marginBottom = `-${(1 - scaleRatio) * 1123}px`; // Adjust height gap
            } else {
                wrapper.style.transform = 'scale(1)';
                wrapper.style.marginBottom = '0';
            }
        }
        window.addEventListener('resize', fitPreview);

        // --- Core Logic ---
        const a4 = document.getElementById('a4Page');
        const editor = document.getElementById('reportEditor');

        function updateTheme() { a4.setAttribute('data-theme', document.getElementById('themeSelect').value); }
        
        function updateFont() { 
            const f = document.getElementById('fontSelect').value;
            a4.className = `a4-wrapper ${f}`;
            if(a4.classList.contains('has-image')) a4.classList.add('has-image');
            editor.className = `editor-paper ${f}`;
        }

        function handleCoverImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Set style directly to ensure it renders
                    a4.style.backgroundImage = `url('${e.target.result}')`;
                    a4.classList.add('has-image');
                    document.getElementById('removeImgBtn').style.display = 'inline-block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeCoverImage() {
            a4.style.backgroundImage = '';
            a4.classList.remove('has-image');
            document.getElementById('coverImageInput').value = '';
            document.getElementById('removeImgBtn').style.display = 'none';
        }

        function addStudent() {
            const div = document.createElement('div');
            div.className = 'ios-list-item';
            div.innerHTML = `<input type="text" class="item-input student-input" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®" oninput="updatePreview()">`;
            document.getElementById('studentsList').appendChild(div);
        }

        function updatePreview() {
            document.getElementById('prevUni').textContent = document.getElementById('uniName').value || 'ÿßŸÑÿ¨ÿßŸÖÿπÿ©';
            document.getElementById('prevTitle').textContent = document.getElementById('reportTitle').value || 'ÿßŸÑÿπŸÜŸàÿßŸÜ';
            document.getElementById('prevSupervisor').textContent = document.getElementById('supervisorName').value || '...';
            document.getElementById('prevYear').textContent = document.getElementById('yearText').value || '...';
            
            const stds = document.querySelectorAll('.student-input');
            const list = document.getElementById('prevStudents');
            list.innerHTML = '';
            stds.forEach(s => { if(s.value) list.innerHTML += `<div>${s.value}</div>`; });
        }

        // --- Editor Logic ---
        function fmt(cmd, val=null) { 
            document.execCommand(cmd, false, val); 
            editor.focus(); 
        }
        function setSize(s) { 
            document.execCommand('fontSize', false, s); 
            editor.focus(); 
        }
        function insertBreak() { 
            document.execCommand('insertHTML', false, '<div class="page-break-marker"></div><br>'); 
        }
        
        // New Direction Logic
        function setDir(dir) {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const node = sel.anchorNode;
                const element = node.nodeType === 3 ? node.parentNode : node;
                let block = element;
                while(block && block !== editor && !['DIV','P','LI'].includes(block.tagName)) {
                    block = block.parentNode;
                }
                
                if(block && block !== editor) {
                    block.style.direction = dir;
                    block.style.textAlign = dir === 'rtl' ? 'right' : 'left';
                } else {
                    const id = "dir-" + Date.now();
                    const html = `<div style="direction:${dir}; text-align:${dir === 'rtl' ? 'right' : 'left'}">${sel.toString() || '&nbsp;'}</div>`;
                    document.execCommand('insertHTML', false, html);
                }
            }
            editor.focus();
        }

        function save() {
            localStorage.setItem('content', editor.innerHTML);
            document.getElementById('wordCount').textContent = editor.innerText.trim().split(/\s+/).length;
        }

        window.onload = () => {
            if(localStorage.getItem('content')) editor.innerHTML = localStorage.getItem('content');
            updatePreview();
            fitPreview();
        };
    </script>
</body>
</html>
